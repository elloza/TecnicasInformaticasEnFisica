# Developer Quickstart: Thebe LiveCode Integration

**Target Audience**: Backend/Frontend developers implementing Thebe integration  
**Duration**: 15-20 minutes to read + understand  
**Prerequisites**: Familiarity with Jupyter Book, Python, JavaScript  
**Last Updated**: 2025-10-20 (Phase 1 Complete)

---

## Quick Overview

**What is Thebe?**
Thebe is a browser-based execution layer for Jupyter Book that enables learners to run Python code directly in the browser using Pyodide (WebAssembly Python). No local Python installation required.

**What are we building?**
We're integrating Thebe into TIF TeachBook so that:
1. ✅ Code examples in `teoria.md` are "Run"-able in the browser
2. ✅ Exercises in `ejercicios.md` can be attempted + executed in-place
3. ✅ Output (plots, tables, errors) displays immediately inline
4. ✅ Kernel state persists within a page (but resets on navigation)
5. ✅ Fallback images for slow computations
6. ✅ Warning banners for heavy computations
7. ✅ Per-tema package configuration

**Why?**
- **Accessibility**: No installation friction for learners
- **Engagement**: Immediate feedback loop enhances learning
- **Scalability**: Browser runtime is free + distributed (via CDN)
- **Pedagogy**: Each tema has isolated kernel (fresh state per module)

---

## Architecture at a Glance

```
┌─────────────────────────────────────────────────────┐
│ Browser (Learner's Machine)                         │
├─────────────────────────────────────────────────────┤
│                                                      │
│  TeachBook HTML (Generated by Jupyter Book)         │
│  ├─ book/tif_python/tema-01/teoria.md (rendered)   │
│  │  ├─ Code Cell 1 [▶ Run] ← Thebe injects button │
│  │  ├─ Code Cell 2 [▶ Run]                         │
│  │  └─ Output Area (stdout/stderr/plots)           │
│  │                                                  │
│  └─ book/tif_python/tema-02/ejercicios.md          │
│     ├─ Exercise 1 [▶ Run]                          │
│     ├─ Exercise 2 [▶ Run] (with fallback image)    │
│     └─ [🔄 Restart Kernel] button                  │
│                                                      │
│  Thebe JavaScript Modules (book/_static/)           │
│  ├─ thebe-init.js (entry point)                    │
│  ├─ thebe-kernel.js (Pyodide initialization)       │
│  ├─ thebe-executor.js (cell execution)             │
│  ├─ thebe-output.js (result rendering)             │
│  ├─ thebe-cells.js (cell detection)                │
│  ├─ thebe-metadata.js (tag parsing)                │
│  ├─ thebe-ui.js (loading indicators)               │
│  ├─ thebe-fallback.js (image fallback)             │
│  └─ thebe-errors.js (error boundary)               │
│                                                      │
│  Pyodide WebAssembly Runtime (CDN-loaded)           │
│  ├─ Python 3.11 interpreter (~30 MB)               │
│  ├─ NumPy, Matplotlib, SciPy (pre-loaded)          │
│  └─ Additional packages (per-tema config)          │
│                                                      │
└─────────────────────────────────────────────────────┘
         │
         │ Page Navigation
         ▼
┌─────────────────────────────────────────────────────┐
│ New Page = Fresh Kernel (Memory Freed)              │
└─────────────────────────────────────────────────────┘
```
│  ├─ NumPy, Matplotlib pre-loaded                   │
│  └─ Standard library                               │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## Key Concepts

### Code Cells
Marked with `{code-cell} ipython3` in Markdown:
```markdown
```{code-cell} ipython3
import numpy as np
x = np.array([1, 2, 3])
print(x)
```
```

When rendered by Jupyter Book + Thebe:
- "Run" button appears (via Thebe)
- Clicking "Run" sends code to Pyodide kernel
- Output appears below cell

### Kernels
One **kernel instance per page** (teoría.md, ejercicios.md, etc.):
- Initialized lazily on first "Run" click
- Maintains global variables across cell executions within the page
- Destroyed on page navigation (fresh kernel on return)
- Can be manually reset via "Clear Kernel" button

### Cell Metadata
Used to control execution + rendering:
```yaml
---
tags: ["hide-output"]        # Don't show output
hide-input: false             # Show code
fallback-image: "fig.png"     # Static image fallback
---
```

### Pyodide
WebAssembly Python runtime:
- Pre-loaded packages: NumPy, Matplotlib, standard library
- Additional packages can be specified per-tema (Task 0.2)
- 50MB initial download (cached by browser)
- 5-10 sec kernel init (first run only)

---

## Development Workflow

### Phase A: MVP (Tema-00 Basic Interactivity)

**Goal**: Get "Run" button working + show output for tema-00

**Step 1: Configure Thebe in `_config.yml`**
```yaml
# book/_config.yml
html:
  extra_footer: "Powered by Jupyter Book + Thebe"

thebe:
  enabled: true
  pyodide_url: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
```

**Step 2: Create Thebe initialization script**
```javascript
// book/_static/thebe-init.js
window.addEventListener('DOMContentLoaded', () => {
  if (window.thebe) {
    window.thebe.bootstrap();
  }
});
```

**Step 3: Link script in `_config.yml`**
```yaml
html:
  extra_js:
    - "_static/thebe-init.js"
```

**Step 4: Build & test**
```bash
pip install -r requirements.txt
jupyter-book build book/
# Open book/_build/html/tif_python/tema-00/teoria.html
# Click "Run" on any code cell → should execute
```

### Phase B: Extended Features (Metadata + Fallbacks)

**Goal**: Support cell metadata + fallback images

**Step 1: Parse cell metadata from Jupyter Book output**
- Extract `tags`, `hide-input`, `hide-output`, `fallback-image` from cell attributes
- Store in memory when page loads

**Step 2: Render fallback images**
```javascript
if (cellMetadata.fallbackImage) {
  const fallbackDiv = document.createElement('div');
  fallbackDiv.innerHTML = `
    <img src="${cellMetadata.fallbackImage}" alt="Fallback output" />
    <p><small>Click 'Run' to execute code locally</small></p>
  `;
  cellElement.prepend(fallbackDiv);
}
```

**Step 3: Hide/show cell output based on metadata**
```javascript
if (cellMetadata.hideOutput) {
  cellElement.querySelector('.cell_output').style.display = 'none';
}
```

### Phase C: Configuration & Ops (Per-Tema Config)

**Goal**: Per-tema package loading + kernel reset

**Step 1: Parse per-tema config from front matter**
```yaml
---
thebe:
  extra_packages: ["scipy"]
  env:
    OMP_NUM_THREADS: "1"
---
```

**Step 2: Initialize Pyodide with custom packages**
```javascript
const config = {
  packages: ['numpy', 'matplotlib', 'scipy'], // from front matter
  env: { OMP_NUM_THREADS: '1' } // from front matter
};
const kernel = new Pyodide(config);
```

**Step 3: Add "Reset Kernel" button + memory monitor**
```javascript
// Add reset button to page
const resetBtn = document.createElement('button');
resetBtn.textContent = 'Clear Kernel';
resetBtn.onclick = () => kernel.destroy();
document.body.prepend(resetBtn);

// Monitor memory
setInterval(() => {
  const memUsage = kernel.memory.current_size;
  if (memUsage > MEMORY_THRESHOLD) {
    showWarning("Kernel using high memory; consider resetting");
  }
}, 5000);
```

---

## Testing Strategy

### Unit Tests
- **Kernel initialization**: Verify Pyodide loads without errors
- **Code execution**: Run sample Python snippets; verify output
- **Cell metadata parsing**: Parse + apply metadata correctly

### Integration Tests
- **Tema-00 teoría**: All 5 theory cells execute in browser
- **Tema-00 ejercicios**: All 10 exercise cells execute + produce expected output
- **Page navigation**: Kernel destroyed on nav; fresh kernel on return
- **Fallback images**: Display correctly; Run button still functional

### Browser Compatibility
- ✅ Chrome 74+
- ✅ Firefox 79+
- ✅ Safari 14.1+
- ✅ Edge 79+
- ✅ WASM support detection + graceful fallback

### Performance Baselines
- First kernel load: <10 seconds (SC-002)
- Cell execution: <5 seconds for typical operations (SC-002)
- Memory: <100MB per kernel (to avoid browser crash)

---

## Common Pitfalls

### ❌ Pitfall 1: Code works locally but fails in Pyodide
**Reason**: Pyodide doesn't have all packages/features
**Solution**: Test in browser during development; use fallbacks for unsupported features

### ❌ Pitfall 2: Kernel state leaks between pages
**Reason**: Shared global kernel instead of per-page
**Solution**: Verify kernel destroyed on `beforeunload` event

### ❌ Pitfall 3: Memory exhaustion after many cells
**Reason**: Kernels not garbage-collected
**Solution**: Implement memory monitoring + warn user to reset kernel

### ❌ Pitfall 4: Pyodide fails to load silently
**Reason**: Network issue or WASM unsupported
**Solution**: Wrap Pyodide init in try-catch; display user-friendly banner

---

## Debugging Tips

### Check if Thebe is loaded
```javascript
// In browser console:
console.log(window.thebe); // Should return Thebe object
console.log(window.pyodide); // Should return Pyodide instance
```

### Debug kernel execution
```javascript
// Add logging to kernel execution:
kernel.executeCode = function(code) {
  console.log('Executing:', code);
  const result = originalExecute(code);
  console.log('Result:', result);
  return result;
};
```

### Test cell rendering
```javascript
// In browser console:
const cells = document.querySelectorAll('.cell');
console.log('Found', cells.length, 'cells');
cells.forEach((cell, i) => {
  const runBtn = cell.querySelector('[role="button"]');
  console.log(`Cell ${i}: has Run button?`, !!runBtn);
});
```

---

## Phase-Specific Code Examples

These examples map to implementation phases in `plan.md` and help developers understand the codebase structure.

### Phase 2A: MVP Implementation

**Example 1: ThebeKernelManager (thebe-kernel.js)**
```javascript
// Singleton pattern for kernel management
class ThebeKernelManager {
  constructor() {
    this.kernel = null;
    this.status = 'uninitialized';
    this.loadedPackages = [];
  }

  async initialize(config) {
    this.status = 'initializing';
    const startTime = performance.now();
    
    try {
      // Load Pyodide from CDN
      const pyodide = await loadPyodide({
        indexURL: config.pyodideUrl
      });
      
      // Pre-load default packages
      await pyodide.loadPackagesFromImports(config.defaultPackages.join('\\n'));
      this.loadedPackages = config.defaultPackages;
      
      this.kernel = pyodide;
      this.status = 'ready';
      
      return {
        kernelId: this.generateKernelId(),
        pyodideVersion: pyodide.version,
        loadedPackages: this.loadedPackages,
        initializationTime: performance.now() - startTime
      };
    } catch (error) {
      this.status = 'error';
      throw new Error(`Kernel initialization failed: ${error.message}`);
    }
  }

  async executeCell(cellId, sourceCode) {
    if (this.status !== 'ready') {
      throw new Error('Kernel not ready');
    }
    
    const startTime = performance.now();
    try {
      const result = await this.kernel.runPythonAsync(sourceCode);
      return {
        success: true,
        output: result,
        executionTime: performance.now() - startTime
      };
    } catch (error) {
      return {
        success: false,
        error: {
          type: error.type || 'RuntimeError',
          message: error.message
        },
        executionTime: performance.now() - startTime
      };
    }
  }
}

// Export singleton instance
const kernelManager = new ThebeKernelManager();
export default kernelManager;
```

**Example 2: Cell Execution (thebe-executor.js)**
```javascript
import kernelManager from './thebe-kernel.js';
import { renderOutput } from './thebe-output.js';

export async function executeCell(cellElement) {
  const cellId = cellElement.dataset.cellId;
  const sourceCode = cellElement.querySelector('.cell_input pre').textContent;
  const outputArea = cellElement.querySelector('.cell_output');
  
  // Show loading indicator
  outputArea.innerHTML = '<div class="thebe-loading">Executing...</div>';
  
  try {
    const result = await kernelManager.executeCell(cellId, sourceCode);
    
    if (result.success) {
      renderOutput(outputArea, result.output);
    } else {
      outputArea.innerHTML = `
        <div class="thebe-error">
          <strong>${result.error.type}</strong>: ${result.error.message}
        </div>
      `;
    }
  } catch (error) {
    outputArea.innerHTML = `
      <div class="thebe-error">Execution failed: ${error.message}</div>
    `;
  }
}
```

**Example 3: Metadata Handling (thebe-metadata.js)**
```javascript
export function applyCellMetadata(cellElement) {
  const metadata = cellElement.dataset;
  
  // Hide input if tagged
  if (metadata.tags?.includes('hide-input')) {
    cellElement.querySelector('.cell_input').style.display = 'none';
  }
  
  // Hide output if tagged
  if (metadata.tags?.includes('hide-output')) {
    cellElement.querySelector('.cell_output').style.display = 'none';
  }
  
  // Show execution time warning
  if (metadata.expectedExecutionTime > 10) {
    const warning = document.createElement('div');
    warning.className = 'thebe-warning';
    warning.textContent = `⚠️ This cell may take ${metadata.expectedExecutionTime}s to execute`;
    cellElement.insertBefore(warning, cellElement.firstChild);
  }
  
  // Recommend local kernel for heavy computations
  if (metadata.localKernelRecommended === 'true') {
    const notice = document.createElement('div');
    notice.className = 'thebe-notice';
    notice.innerHTML = `
      💡 For better performance, consider running this locally. 
      <a href="/instalacion-vscode.html">Installation guide</a>
    `;
    cellElement.insertBefore(notice, cellElement.firstChild);
  }
}
```

### Phase 2B: Extended Features

**Example 4: Fallback Images (thebe-fallback.js)**
```javascript
export function setupFallbackImages() {
  document.querySelectorAll('[data-fallback-image]').forEach(cell => {
    const fallbackPath = cell.dataset.fallbackImage;
    const outputArea = cell.querySelector('.cell_output');
    
    // Create fallback container (hidden by default)
    const fallback = document.createElement('div');
    fallback.className = 'thebe-fallback';
    fallback.style.display = 'none';
    fallback.innerHTML = `
      <img src="${fallbackPath}" alt="Expected output">
      <p class="fallback-caption">Pre-computed output (Thebe unavailable)</p>
    `;
    
    outputArea.appendChild(fallback);
    
    // Show fallback if kernel fails
    window.addEventListener('thebe:kernel:error', () => {
      fallback.style.display = 'block';
    });
  });
}
```

**Example 5: Graceful Degradation (thebe-degradation.js)**
```javascript
export function checkWasmSupport() {
  try {
    if (typeof WebAssembly === 'object' 
        && typeof WebAssembly.instantiate === 'function') {
      const module = new WebAssembly.Module(
        Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00)
      );
      return WebAssembly.Module instanceof Function;
    }
  } catch (e) {}
  return false;
}

export function showFallbackMode() {
  const banner = document.createElement('div');
  banner.className = 'thebe-degradation-banner';
  banner.innerHTML = `
    <strong>⚠️ Interactive Python execution unavailable</strong>
    <p>Your browser doesn't support WebAssembly. You'll see pre-computed outputs.</p>
    <a href="/instalacion-vscode.html">Run code locally with VS Code</a>
  `;
  
  document.querySelector('.bd-article').insertBefore(
    banner, 
    document.querySelector('.bd-article').firstChild
  );
  
  // Disable all Run buttons
  document.querySelectorAll('.thebe-launch-button').forEach(btn => {
    btn.disabled = true;
    btn.textContent = 'Execution Unavailable';
  });
  
  // Show all fallback images
  document.querySelectorAll('.thebe-fallback').forEach(fb => {
    fb.style.display = 'block';
  });
}
```

### Phase 2C: Configuration & Rollout

**Example 6: Per-Tema Configuration (thebe-config.js)**
```javascript
export function getPageThebeConfig() {
  // Extract tema from URL (e.g., /tema-02/teoria.html → tema-02)
  const urlPath = window.location.pathname;
  const temaMatch = urlPath.match(/tema-(\d+)/);
  const temaId = temaMatch ? `tema-${temaMatch[1]}` : 'default';
  
  // Default configuration
  const baseConfig = {
    enabled: true,
    pyodideUrl: 'https://cdn.jsdelivr.net/pyodide/v0.23.0/full/',
    defaultPackages: ['numpy', 'matplotlib'],
    initTimeout: 30000,
    executionTimeout: 30000
  };
  
  // Per-tema overrides (from page YAML front matter)
  const temaOverrides = window.THEBE_CONFIG_OVERRIDES || {};
  
  return {
    ...baseConfig,
    ...temaOverrides[temaId]
  };
}

export async function initializeWithTemaConfig() {
  const config = getPageThebeConfig();
  
  if (!config.enabled) {
    console.log('Thebe disabled for this tema');
    return;
  }
  
  // Override packages if specified in page front matter
  if (window.EXTRA_PACKAGES) {
    config.defaultPackages = [...config.defaultPackages, ...window.EXTRA_PACKAGES];
  }
  
  return await kernelManager.initialize(config);
}
```

**Example 7: Author Syntax (Markdown)**
```markdown
---
extra_packages: ['pandas', 'scipy']
thebe_config:
  executionTimeout: 60000  # Override for heavy computations
---

# Tema 5: Análisis de Datos

## Ejemplo interactivo

\`\`\`{code-cell} python
:tags: [hide-output, thebe-init]
:fallback-image: /_static/figures/tema-05/output-001.png
:expected-execution-time: 15

import pandas as pd
import matplotlib.pyplot as plt

# Load dataset (pre-loaded via micropip)
df = pd.read_csv('https://example.com/data.csv')
df.head()
\`\`\`

\`\`\`{code-cell} python
:tags: [local-kernel-recommended]
:expected-execution-time: 45

# Heavy computation (recommend local kernel)
result = df.groupby('category').agg({'value': ['mean', 'std']})
result.plot(kind='bar')
plt.show()
\`\`\`
```

---

## Testing Checklist

After implementing each phase, verify:

**Phase 2A (MVP)**:
- [ ] Kernel initializes in <10 seconds (SC-002)
- [ ] Cells execute and show output (SC-001)
- [ ] Restart button clears variables (SC-006)
- [ ] Error messages are user-friendly (SC-008)
- [ ] Tema-00 teoría fully interactive

**Phase 2B (Extended)**:
- [ ] Fallback images show when kernel unavailable (SC-003)
- [ ] Warnings display for slow cells (SC-009)
- [ ] WASM detection works (graceful degradation)
- [ ] Local kernel recommendations visible

**Phase 2C (Rollout)**:
- [ ] Per-tema package overrides work (SC-004)
- [ ] All 7 temas migrated and tested
- [ ] Memory usage <1 GB (SC-007)
- [ ] Build time <5 minutes (SC-010)

---

## Resources

- **Jupyter Book Docs**: https://jupyterbook.org/interactive/thebe.html
- **Thebe GitHub**: https://github.com/executablebooks/thebe
- **Pyodide Docs**: https://pyodide.org/en/stable/
- **TIF Constitution**: `.specify/memory/constitution.md` (principles guide)
- **Feature Spec**: `specs/001-thebe-livecode-integration/spec.md` (requirements)
- **Implementation Plan**: `specs/001-thebe-livecode-integration/plan.md` (phases)

---

## Next Steps

1. **Phase 0**: Research tasks (1-2 days) → populate `research.md` ✅ **COMPLETED**
2. **Phase 1**: Design + data model (1 day) → create `data-model.md` + `contracts/` ✅ **COMPLETED**
3. **Phase 2A**: MVP implementation (5-7 days) → tema-00 interactive ⏳ **NEXT**
4. **Phase 2B**: Extended features (4-5 days) → metadata + fallbacks
5. **Phase 2C**: Configuration (6-8 days) → full curriculum rollout

---

**Quickstart Version**: 1.0.0 | **Updated**: 2025-10-20